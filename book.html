<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirm Your Booking - Tutormee</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Tutormee</h1>
        <p>Specialist online tutoring for A-Level & GCSE</p>
        <div class="website-link">
            Visit us: <a href="https://www.Tutormee.co.uk" target="_blank">www.Tutormee.co.uk</a>
        </div>
    </header>
    <nav>
        <a href="index.html">Home</a>
        <a href="Our-services.html">Our Services</a>
        <a href="bookings.html">Bookings</a>
        <a href="videos.html">Videos</a>
        <a href="contact-us.html">Contact Us</a>
        <a href="login.html">Admin Login</a>
    </nav>
    
    <div class="container" id="booking-container">
        <h2>Confirm Your Booking</h2>
        <div id="slot-details-container" style="display: none;">
            <p>You have selected the following time slot:</p>
            <div id="selected-slot-details" class="slot-details"></div>
        </div>
        <form id="booking-form">
            <div class="form-group">
                <label for="student-name">Your Full Name</label>
                <input type="text" id="student-name" required>
            </div>
            <div class="form-group">
                <label for="student-email">Your Email Address</label>
                <input type="email" id="student-email" required>
            </div>
            <div class="form-group">
                <label for="student-phone">Your Phone Number</label>
                <input type="tel" id="student-phone" required>
            </div>
            <button type="submit" id="confirm-booking-btn" class="cta-btn" disabled>Confirm Booking</button>
        </form>
        <p id="form-message" class="message"></p>
    </div>

    <footer>&copy; 2025 Tutormee</footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAfOf2vN2YzPUAO6kfz4HSu8HYkK8TWZHY",
            authDomain: "tutorme-99ca8.firebaseapp.com",
            databaseURL: "https://tutorme-99ca8-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "tutorme-99ca8",
            storageBucket: "tutorme-99ca8.appspot.com",
            messagingSenderId: "1012080798952",
            appId: "1:1012080798952:web:e9067e9a68bb1841e72d5d",
            measurementId: "G-L8TJGV46E6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const form = document.getElementById('booking-form');
        const nameInput = document.getElementById('student-name');
        const emailInput = document.getElementById('student-email');
        const phoneInput = document.getElementById('student-phone');
        const confirmBtn = document.getElementById('confirm-booking-btn');
        const messageEl = document.getElementById('form-message');
        const slotDetailsContainer = document.getElementById('slot-details-container');
        const selectedSlotDetails = document.getElementById('selected-slot-details');
        const bookingContainer = document.getElementById('booking-container');

        const urlParams = new URLSearchParams(window.location.search);
        const slotId = urlParams.get('slotId');
        let selectedSlotDate = null;

        if (!slotId) {
            bookingContainer.innerHTML = "<h2>Error</h2><p>No booking slot was selected. Please <a href='bookings.html'>go back</a> and choose a time.</p>";
        } else {
            const slotRef = db.ref(`availableSlots/${slotId}`);
            slotRef.once('value').then(snapshot => {
                if (!snapshot.exists() || snapshot.val().isBooked) {
                    bookingContainer.innerHTML = "<h2>Sorry, this slot is no longer available.</h2><p>It may have been booked by someone else. Please <a href='bookings.html'>choose another slot</a>.</p>";
                    return;
                }
                const slotData = snapshot.val();
                selectedSlotDate = slotData.date;
                const formattedDate = new Date(selectedSlotDate).toLocaleString('en-GB', { dateStyle: 'full', timeStyle: 'short' });

                selectedSlotDetails.textContent = formattedDate;
                slotDetailsContainer.style.display = 'block';
                confirmBtn.disabled = false;
            });
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Submitting...';
            
            // Create a single data object to make it easier to reuse
            const studentData = {
                studentName: nameInput.value,
                studentEmail: emailInput.value,
                studentPhone: phoneInput.value,
                date: selectedSlotDate
            };

            const bookingsRef = db.ref('bookings');
            
            // 1. Push the student data to the 'bookings' part of the database
            bookingsRef.push(studentData)
            .then(() => {
                // 2. Once saved, update the original time slot to mark it as booked
                const slotToUpdateRef = db.ref(`availableSlots/${slotId}`);
                return slotToUpdateRef.update({ isBooked: true });
            })
            .then(() => {
                // 3. **NEW STEP**: Once everything is saved, call our email function
                // Netlify makes our function available at this special URL
                fetch('/.netlify/functions/send-confirmation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        studentName: studentData.studentName, 
                        studentEmail: studentData.studentEmail,
                        bookedDate: studentData.date // Pass the date to the function
                    })
                })
                // Log if the email trigger fails, but don't stop the user's success message
                .catch(err => console.error('Email trigger failed:', err));
                
                // 4. Show the success message to the user, now mentioning the email
                bookingContainer.innerHTML = "<h2>Thank You!</h2><p>Your free consultation has been booked successfully. A confirmation email has been sent to your inbox.</p>";
            })
            .catch(error => {
                console.error("Booking failed:", error);
                messageEl.textContent = "An error occurred. Please try again.";
                messageEl.className = 'message error';
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirm Booking';
            });
        });
    </script>
</body>
</html>
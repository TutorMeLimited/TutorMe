<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Tutormee</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Tutormee</h1>
        <p>Specialist online tutoring for A-Level & GCSE</p>
        <div class="website-link">
            Visit us: <a href="index.html" target="_blank">www.Tutormee.co.uk</a>
        </div>
    </header>
    <nav>
        <a href="index.html">Home</a>
        <a href="Our-services.html">Our Services</a>
        <a href="bookings.html">Bookings</a>
        <a href="videos.html">Videos</a>
        <a href="contact-us.html">Contact Us</a>
        <a href="login.html">Admin Login</a>
        <a id="sign-out-link" style="display: none;">Sign Out</a>
    </nav>
    <div class="container" id="dashboard-container">
        <h2>Admin Dashboard</h2>
        <p id="auth-status">Verifying authentication...</p>

        <div id="dashboard-content" style="display: none;">
            <div class="section">
                <h3>Upcoming Bookings</h3>
                <div class="list" id="bookings-list"></div>
            </div>
            <div class="section">
                <h3>Unsold (Unbooked & Past) Slots</h3>
                <div class="list" id="unsold-list"></div>
            </div>
            <div class="section">
                <h3>Available Slots</h3>
                <form id="add-slot-form" class="form-inline">
                    <input type="datetime-local" id="slot-date" required>
                    <button type="submit" class="btn">Add Available Date</button>
                    <span id="slot-msg" class="message-span"></span>
                </form>
                <div class="list" id="slots-list"></div>
            </div>
            <div class="section">
                <h3>Videos</h3>
                <form id="add-video-form" class="form-inline">
                    <input type="text" id="video-id" placeholder="YouTube Video ID or URL" required>
                    <button type="submit" class="btn">Add Video</button>
                    <span id="video-msg" class="message-span"></span>
                </form>
                <div class="list" id="videos-list"></div>
            </div>
        </div>
    </div>
    <footer>
        &copy; 2025 Tutormee | <a href="index.html" target="_blank">www.Tutormee.co.uk</a>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAfOf2vN2YzPUAO6kfz4HSu8HYkK8TWZHY",
            authDomain: "tutorme-99ca8.firebaseapp.com",
            databaseURL: "https://tutorme-99ca8-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "tutorme-99ca8",
            storageBucket: "tutorme-99ca8.firebasestorage.app",
            messagingSenderId: "1012080798952",
            appId: "1:1012080798952:web:e9067e9a68bb1841e72d5d",
            measurementId: "G-L8TJGV46E6"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        const authStatus = document.getElementById('auth-status');
        const dashboardContent = document.getElementById('dashboard-content');
        const signOutLink = document.getElementById('sign-out-link');
        
        auth.onAuthStateChanged(user => {
            if (user) {
                authStatus.textContent = `Welcome, ${user.email}`;
                dashboardContent.style.display = 'block';
                signOutLink.style.display = 'inline';
                loadDashboardData();
            } else {
                window.location.href = 'login.html';
            }
        });

        signOutLink.addEventListener('click', () => {
            auth.signOut();
        });

        const bookingsList = document.getElementById('bookings-list');
        const unsoldList = document.getElementById('unsold-list');
        const slotsList = document.getElementById('slots-list');
        const videosList = document.getElementById('videos-list');
        const addSlotForm = document.getElementById('add-slot-form');
        const addVideoForm = document.getElementById('add-video-form');
        const slotDateInput = document.getElementById('slot-date');
        const videoIdInput = document.getElementById('video-id');
        const slotMsg = document.getElementById('slot-msg');
        const videoMsg = document.getElementById('video-msg');

        function loadDashboardData() {
            loadBookings();
            loadUnsoldSlots();
            loadAvailableSlots();
            loadVideos();
        }
        
        const formatDate = (isoString) => new Date(isoString).toLocaleString('en-GB', { dateStyle: 'full', timeStyle: 'short' });

        const renderListItem = (listElement, text, id, onRemove) => {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.innerHTML = `<span>${text}</span>`;
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = () => onRemove(id);
            item.appendChild(removeBtn);
            listElement.appendChild(item);
        };
        
        const setupListListener = (listElement, dbPath, filterFn, formatFn, emptyMsg) => {
            const dbRef = db.ref(dbPath).orderByChild('date');
            dbRef.on('value', snapshot => {
                listElement.innerHTML = '';
                let hasItems = false;
                snapshot.forEach(childSnapshot => {
                    const item = childSnapshot.val();
                    if (filterFn(item)) {
                        hasItems = true;
                        const text = formatFn(item);
                        renderListItem(listElement, text, childSnapshot.key, (id) => db.ref(`${dbPath}/${id}`).remove());
                    }
                });
                if (!hasItems) {
                    listElement.innerHTML = `<p>${emptyMsg}</p>`;
                }
            });
        };

        const loadBookings = () => {
            setupListListener(bookingsList, 'bookings', 
                booking => new Date(booking.date) > new Date(), 
                // Updated format function to include email and phone
                booking => `
                    ${formatDate(booking.date)} - <strong>${booking.studentName || 'N/A'}</strong><br>
                    <small>Email: ${booking.studentEmail || 'N/A'} | Phone: ${booking.studentPhone || 'N/A'}</small>
                `,
                'No upcoming bookings.'
            );
        };

        const loadUnsoldSlots = () => {
            setupListListener(unsoldList, 'availableSlots', 
                slot => new Date(slot.date) < new Date() && !slot.isBooked, 
                slot => formatDate(slot.date), 
                'No past unsold slots.'
            );
        };

        const loadAvailableSlots = () => {
            setupListListener(slotsList, 'availableSlots',
                slot => new Date(slot.date) > new Date() && !slot.isBooked,
                slot => formatDate(slot.date), 
                'No available slots to show.'
            );
        };

        const loadVideos = () => {
            const videosRef = db.ref('videos');
            videosRef.on('value', snapshot => {
                videosList.innerHTML = '';
                if (!snapshot.exists()) {
                    videosList.innerHTML = `<p>No videos added yet.</p>`;
                    return;
                }
                snapshot.forEach(childSnapshot => {
                    const video = childSnapshot.val();
                    const text = `<a href="https://www.youtube.com/watch?v=${video.id}" target="_blank">youtube.com/watch?v=${video.id}</a>`;
                    renderListItem(videosList, text, childSnapshot.key, (id) => videosRef.child(id).remove());
                });
            });
        };

        const showMessage = (element, text, isSuccess) => {
            element.textContent = text;
            element.className = isSuccess ? 'message-span success' : 'message-span error';
            element.style.opacity = 1;
            setTimeout(() => { element.style.opacity = 0; }, 3000);
        };

        addSlotForm.addEventListener('submit', e => {
            e.preventDefault();
            if (!slotDateInput.value) return;
            db.ref('availableSlots').push({ date: slotDateInput.value, isBooked: false })
                .then(() => showMessage(slotMsg, 'Slot added!', true))
                .catch(err => showMessage(slotMsg, err.message, false));
            addSlotForm.reset();
        });

        addVideoForm.addEventListener('submit', e => {
            e.preventDefault();
            let videoId = videoIdInput.value.trim();
            if (!videoId) return;
            try {
                if (videoId.includes("youtube.com") || videoId.includes("youtu.be")) {
                    const url = new URL(videoId);
                    videoId = url.searchParams.get('v') || url.pathname.split('/').pop();
                }
            } catch (err) { /* Not a valid URL, assume it's an ID */ }

            if (!videoId) {
                showMessage(videoMsg, 'Invalid YouTube ID or URL.', false);
                return;
            }
            db.ref('videos').push({ id: videoId })
                .then(() => showMessage(videoMsg, 'Video added!', true))
                .catch(err => showMessage(videoMsg, err.message, false));
            addVideoForm.reset();
        });
    </script>
</body>
</html>